<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>AR Camiseta - Worker (Centered, stricter match)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font-family:Arial, sans-serif}
    #videoWrapper{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;overflow:hidden}
    video#cam{width:100%;height:100%;object-fit:cover;}
    canvas#overlay{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none; z-index:20}
    #overlayContainer{
      position:fixed; left:50%; top:50%;
      pointer-events:none; z-index:9999;
      display:none; transform-origin:center center;
      background:transparent; transform:translate(-50%,-50%);
    }
    #overlayContainer > video { display:block; width:100%; height:100%; background:transparent; object-fit:cover; }
    #controls{position:fixed; right:12px; top:60px; z-index:10000; display:flex; flex-direction:column; gap:8px}
    .ctrlBtn{padding:10px 12px;border-radius:8px;border:none;background:#ff4fa8;color:#fff;font-weight:600}
    #startBtn{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);padding:14px 18px;background:#ff4fa8;border-radius:10px;border:none;color:#fff;font-size:18px;z-index:40}
    #log{position:fixed;left:8px;top:8px;background:rgba(0,0,0,0.6);padding:6px 8px;border-radius:6px;font-size:12px;z-index:40}
    #bigMatch{position:fixed;left:8px;top:48px;font-size:18px;font-weight:700;color:#fff;text-shadow:0 0 6px #000;z-index:40}
    #forcePlay{position:fixed;left:50%;top:70%;transform:translate(-50%,-50%);z-index:10001;padding:12px 18px;background:#ff4fa8;color:#fff;border-radius:8px;border:none;display:none}
  </style>
</head>
<body>
  <div id="videoWrapper">
    <video id="cam" autoplay playsinline muted></video>
    <canvas id="overlay"></canvas>
  </div>

  <div id="overlayContainer"></div>

  <div id="controls">
    <button id="testShow" class="ctrlBtn">Mostrar animación de prueba</button>
    <button id="testHide" class="ctrlBtn">Ocultar animación</button>
    <button id="toggleMode" class="ctrlBtn">Modo: Precisión</button>
  </div>

  <button id="startBtn">Activar AR</button>
  <button id="forcePlay">Toca para reproducir animación</button>

  <div id="log">iniciando...</div>
  <div id="bigMatch">Match: --</div>

<script>
/* ---------- CONFIG ---------- */
const TARGET_URL = './ilustracion.png';
const ANIM_URL = './Animacion.webm';
let RES_SCALE = 0.40;     // escala de procesamiento (ajusta)
let FRAME_SKIP = 3;
let MODE = 'precision';   // 'precision'|'speed'
const REQUIRED_MATCHES = 10;    // número mínimo de good matches para considerar detección válida
const REQUIRED_INLIERS = 8;     // inliers mínimos
/* ---------------------------- */

const cam = document.getElementById('cam');
const overlay = document.getElementById('overlay');
const ctx = overlay.getContext('2d');
const overlayContainer = document.getElementById('overlayContainer');
const startBtn = document.getElementById('startBtn');
const logEl = document.getElementById('log');
const bigMatch = document.getElementById('bigMatch');
const testShow = document.getElementById('testShow');
const testHide = document.getElementById('testHide');
const toggleMode = document.getElementById('toggleMode');
const forcePlay = document.getElementById('forcePlay');

let worker = null;
let streaming = false;
let procW = 1, procH = 1;
let offscreenForTransfer = null;
let frameCounter = 0;
let templW = 0, templH = 0; // recibidos desde worker

function log(s){ logEl.textContent = s; console.log(s); }

const overlayVideoMarkup = (filename) => `
  <video id="fxVideo" autoplay loop muted playsinline preload="auto" crossorigin="anonymous" style="background:transparent;display:block;">
    <source src="${filename}" type="video/webm">
    <source src="${filename.replace('.webm','.mp4')}" type="video/mp4">
  </video>`;

function showOverlayCenteredFixed(sizePx){
  // center the overlayContainer (CSS already centers). Set width/height preserving aspect ratio from templW/templH
  let w = sizePx;
  let h = Math.round(sizePx * (templH / templW));
  // if templ dims unknown fallback to square
  if (!templW || !templH) { h = w; }
  const fx = document.getElementById('fxVideo');
  if (!fx) overlayContainer.innerHTML = overlayVideoMarkup(ANIM_URL);
  const v = document.getElementById('fxVideo');
  overlayContainer.style.width = Math.max(10, w) + 'px';
  overlayContainer.style.height = Math.max(10, h) + 'px';
  overlayContainer.style.display = 'block';
  overlayContainer.style.visibility = 'visible';
  try { v.play().then(()=>{ log('video play ok'); forcePlay.style.display='none'; }).catch(e=>{ log('autoplay err')}); } catch(e){}
}
function hideOverlay(){ const fx = document.getElementById('fxVideo'); if (fx) try{ fx.pause(); }catch(e){} overlayContainer.style.display='none'; overlayContainer.style.visibility='hidden'; }

forcePlay.addEventListener('click', ()=>{ const fx = document.getElementById('fxVideo'); if (fx) fx.play().catch(()=>{}); forcePlay.style.display='none'; });
testShow.addEventListener('click', ()=> showOverlayCenteredFixed(Math.round(window.innerWidth*0.5)));
testHide.addEventListener('click', ()=> hideOverlay());

toggleMode.addEventListener('click', ()=>{
  if (MODE === 'precision'){
    MODE = 'speed'; RES_SCALE = 0.22; FRAME_SKIP = 5; toggleMode.textContent = 'Modo: Velocidad'; log('Modo velocidad');
  } else {
    MODE = 'precision'; RES_SCALE = 0.40; FRAME_SKIP = 3; toggleMode.textContent = 'Modo: Precisión'; log('Modo precisión');
  }
  // on next frame procW/procH will be recomputed
});

/* camera start */
startBtn.addEventListener('click', async ()=>{ startBtn.style.display='none'; log('Activando cámara...'); await startCamera(); });

async function startCamera(){
  try {
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
    cam.srcObject = stream;
    await cam.play();
    streaming = true;
    resizeCanvas();
    initWorker();
    scheduleFrame();
  } catch(e){ alert('Error al abrir la cámara: ' + e.message); console.error(e); }
}

function resizeCanvas(){
  overlay.width = cam.videoWidth; overlay.height = cam.videoHeight;
  overlay.style.width = cam.clientWidth + 'px'; overlay.style.height = cam.clientHeight + 'px';
  procW = Math.max(1, Math.floor(cam.videoWidth * RES_SCALE));
  procH = Math.max(1, Math.floor(cam.videoHeight * RES_SCALE));
  try {
    offscreenForTransfer = new OffscreenCanvas(procW, procH);
  } catch(e) {
    const c = document.createElement('canvas'); c.width = procW; c.height = procH; offscreenForTransfer = c;
  }
}

/* worker init */
function initWorker(){
  if (worker) { worker.terminate(); worker = null; }
  worker = new Worker('worker.js');
  worker.onmessage = (ev)=>{
    const d = ev.data;
    if (d.type === 'ready'){ log('Worker ready — cargando template...'); worker.postMessage({type:'init', targetUrl: TARGET_URL, procW, procH}); }
    else if (d.type === 'log'){ console.log('worker:', d.msg); }
    else if (d.type === 'error'){ console.error('worker error:', d.msg); }
    else if (d.type === 'templateInfo'){ templW = d.w; templH = d.h; console.log('templ size from worker', templW, templH); }
    else if (d.type === 'result'){ handleWorkerResult(d); }
  };
}

/* handle results: now center video, no rotation; only show when good enough */
function handleWorkerResult(d){
  bigMatch.textContent = `Matches: ${d.matches} | Inliers: ${d.inliers}`;
  // stricter gating
  if (d.matches >= REQUIRED_MATCHES && d.inliers >= REQUIRED_INLIERS){
    // pick a visible size based on screen width (half screen), but clamp if template aspect extreme
    const sizePx = Math.round(Math.min(window.innerWidth * 0.6, window.innerHeight * 0.6));
    showOverlayCenteredFixed(sizePx);
  } else {
    hideOverlay();
  }
}

/* send downscaled frame to worker */
async function sendFrameToWorker(){
  if (!streaming || !worker) return;
  // recompute proc size if RES_SCALE changed
  const newW = Math.max(1, Math.floor(cam.videoWidth * RES_SCALE));
  const newH = Math.max(1, Math.floor(cam.videoHeight * RES_SCALE));
  if (newW !== procW || newH !== procH){ procW = newW; procH = newH; resizeCanvas(); worker.postMessage({type:'resize', procW, procH}); }

  try {
    let ctx2 = offscreenForTransfer.getContext('2d');
    ctx2.drawImage(cam, 0, 0, procW, procH);
    let bitmap;
    if (offscreenForTransfer.transferToImageBitmap){
      bitmap = offscreenForTransfer.transferToImageBitmap();
    } else {
      const blob = await new Promise(r=> offscreenForTransfer.toBlob(r,'image/png'));
      bitmap = await createImageBitmap(blob);
    }
    worker.postMessage({type:'frame', bitmap: bitmap}, [bitmap]);
  } catch(err){
    console.error('sendFrameToWorker err', err);
  }
}

/* scheduling */
function scheduleFrame(){
  if (!streaming) return;
  frameCounter = (frameCounter + 1) % FRAME_SKIP;
  if (cam.requestVideoFrameCallback){
    cam.requestVideoFrameCallback(()=>{ if (frameCounter===0) sendFrameToWorker(); scheduleFrame(); });
  } else {
    requestAnimationFrame(()=>{ if (frameCounter===0) sendFrameToWorker(); scheduleFrame(); });
  }
}

/* cleanup */
window.addEventListener('pagehide', ()=>{
  try{ if (worker) worker.terminate(); }catch(e){}
  try{ const s = cam.srcObject; if (s) s.getTracks().forEach(t=>t.stop()); }catch(e){}
});

</script>
</body>
</html>
