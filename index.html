<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AR Camiseta - Debug init</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <style>
    body, html { margin:0; padding:0; height:100%; overflow:hidden; background:#000; color:#fff; font-family:Arial, sans-serif; }
    #startBtn { position:fixed; left:50%; top:50%; transform:translate(-50%,-50%); padding:12px 18px; font-size:16px; border-radius:8px; background:#ff4fa8; color:white; border:none; cursor:pointer; display:none; }
    #note { position:fixed; bottom:10px; left:10px; right:10px; text-align:center; font-size:14px; opacity:0.9; }
    #log { position:fixed; top:8px; left:8px; padding:8px; background:rgba(0,0,0,0.6); color:#fff; border-radius:6px; max-width:40%; font-size:12px; }
  </style>
</head>
<body>
  <div id="log">Inicializando...</div>
  <button id="startBtn">Activar AR</button>
  <div id="note">Apunta la cámara hacia la imagen de la camiseta</div>

  <!-- a-scene: dejamos mindar-image vacío inicialmente; lo rellenamos dinámicamente -->
  <a-scene id="arScene"
      embedded color-space="sRGB" vr-mode-ui="enabled: false"
      renderer="colorManagement: true; physicallyCorrectLights: true;">
    <a-entity camera></a-entity>
    <a-entity mindar-image-target="targetIndex: 0">
      <a-entity id="animHeart" position="0 0 0">
        <a-sphere radius="0.01" color="#ff7ac8" opacity="0.85"
          animation__appear="property: scale; from: 0 0 0; to: 0.15 0.15 0.15; dur: 800; easing: easeOutQuad; loop: true; dir: alternate"
          animation__pulse="property: opacity; from: 0.5; to: 1; dur: 1000; loop: true; dir: alternate"
          animation__spin="property: rotation; to: 0 360 0; dur: 5000; loop: true">
        </a-sphere>
        <a-ring radius-inner="0.02" radius-outer="0.022" color="#ff9bd5" opacity="0.7" rotation="-90 0 0"
          animation__grow="property: scale; from: 0.1 0.1 0.1; to: 2 2 2; dur: 2000; loop: true"
          animation__fade="property: opacity; from: 0.8; to: 0; dur: 2000; loop: true">
        </a-ring>
      </a-entity>
    </a-entity>
  </a-scene>

  <script>
(async function(){
  const LOG = (s) => { console.log(s); const d = document.getElementById('log'); if(d) d.textContent = s; };
  const startBtn = document.getElementById('startBtn');
  const sceneEl = document.getElementById('arScene');

  const rawUrl = "https://raw.githubusercontent.com/xTorres97/Camisasqr/master/targets.mind";

  try {
    LOG('Descargando targets.mind desde raw...');
    const resp = await fetch(rawUrl);
    if (!resp.ok) throw new Error('HTTP ' + resp.status + ' al descargar targets.mind');
    const arr = await resp.arrayBuffer();
    LOG('targets.mind descargado: ' + arr.byteLength + ' bytes — creando blob...');
    const blob = new Blob([arr], {type: 'application/octet-stream'});
    const blobUrl = URL.createObjectURL(blob);

    // Espera a que AFRAME exista y esté listo
    if (typeof AFRAME === 'undefined') {
      LOG('Esperando a AFRAME...');
      await new Promise(r => {
        let t = 0;
        const wait = setInterval(() => {
          t += 50;
          if (typeof AFRAME !== 'undefined' || t > 3000) {
            clearInterval(wait);
            r();
          }
        }, 50);
      });
    }

    // Asignar la propiedad usando objeto (evita problemas de parseo con blob:)
    LOG('Asignando blobUrl al componente mindar-image (objeto) ...');
    sceneEl.setAttribute('mindar-image', { imageTargetSrc: blobUrl, autoStart: false });

    // Pequeña pausa para que A-Frame registre el cambio
    await new Promise(r => setTimeout(r, 120));

    // Cargar la librería MindAR (solo ahora)
    LOG('Cargando script mindar-image-aframe.prod.js dinámicamente...');
    await new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/npm/mind-ar@1.1.4/dist/mindar-image-aframe.prod.js";
      s.onload = () => { LOG('Script MindAR cargado.'); resolve(); };
      s.onerror = (e) => { reject(new Error('No se pudo cargar la librería MindAR: ' + e)); };
      document.head.appendChild(s);
    });

    // Espera pequeña a que el componente se registre
    await new Promise(r => setTimeout(r, 150));

    // Habilitar botón
    startBtn.style.display = 'inline-block';
    startBtn.disabled = false;
    LOG('Listo: pulsa "Activar AR" para iniciar la cámara.');

  } catch (e) {
    LOG('ERROR carga .mind o script: ' + (e && e.message ? e.message : e));
    alert('Error cargando targets.mind o la librería MindAR: ' + (e && e.message ? e.message : e));
    console.error(e);
  }
})();
</script>

</body>
</html>